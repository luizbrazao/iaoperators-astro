---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { ui, getLocale, type Locale } from "../../../i18n/ui";
import { fetchBlogPosts } from "../../../lib/blog";

type BlogPost = {
  id: string;
  slug: string;
  title: string;
  category: string;
  date: string;
  imageUrl?: string;
  metaDescription?: string;
  content?: string;
  locale?: "es" | "pt" | "en";
};

export async function getStaticPaths() {
  const locales: Locale[] = ["es", "pt", "en"];

  const postsByLocale = await Promise.all(
    locales.map(async (loc) => ({ locale: loc, posts: (await fetchBlogPosts(loc)) as BlogPost[] })),
  );

  return postsByLocale.flatMap(({ locale: loc, posts }) =>
    posts.map((post) => ({
      params: { locale: loc, slug: post.slug },
      props: { locale: loc, post },
    })),
  );
}

const { locale: localeParam, post } = Astro.props as { locale: Locale; post: BlogPost };

const locale = getLocale(localeParam);
const dict = ui[locale];

const site = (Astro.site?.toString() ?? "https://iaoperators.com").replace(/\/$/, "");

// Canonical “anti-duplicação”: se o post não tem locale, canonical cai em ES
const canonicalLocale = (post.locale ?? "es") as Locale;
const isDuplicateLocale = !post.locale && locale !== canonicalLocale;

const canonicalPath = Astro.url.pathname.replace(/\/?$/, "/");
const canonicalUrl = new URL(canonicalPath, site).toString();

// SEO
const title = post.title;
const description = post.metaDescription ?? dict.meta.description;

// Tempo de leitura (mesma ideia do antigo)
const safeContent = typeof post.content === "string" ? post.content : "";
const readMinutes = Math.max(3, Math.ceil(safeContent.length / 1500));

// Data
const parsedDate = post.date ? new Date(post.date) : null;
const hasValidDate = parsedDate instanceof Date && !Number.isNaN(parsedDate.getTime());
const formattedDate = hasValidDate
  ? parsedDate!.toLocaleDateString(locale, { year: "numeric", month: "long", day: "numeric" })
  : dict.meta.dateUnavailable ?? "Data indisponível";

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: title,
    description,
    datePublished: post.date,
    dateModified: post.date,
    mainEntityOfPage: canonicalUrl,
    image: post.imageUrl ? [post.imageUrl] : undefined,
    author: { "@type": "Organization", name: "IA Operators", url: site },
    publisher: { "@type": "Organization", name: "IA Operators", url: site },
  },
];

// Share URLs (estáticos, sem depender de window)
const shareLinkedIn = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(canonicalUrl)}`;
const shareX = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(
  canonicalUrl
)}`;
---

<BaseLayout
  title={title}
  description={description}
  jsonLd={jsonLd}
  ogImage={post.imageUrl ?? "/og.png"}
  ogImageAlt={title}
  ogType="article"
  robots={isDuplicateLocale ? "noindex,follow" : "index,follow"}
>
  <!-- Breadcrumb / Voltar (fixo no desktop) -->
  <div class="fixed top-24 left-4 z-40 hidden xl:block">
    <a
      href={`/${locale}/blog/`}
      class="flex items-center justify-center w-10 h-10 rounded-full bg-white/5 border border-white/10 text-gray-400 hover:text-white hover:bg-white/10 transition-all hover:-translate-x-1"
      aria-label="Voltar ao blog"
      title="Voltar ao blog"
    >
      <!-- ArrowLeft -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
        <path
          d="M15 18l-6-6 6-6"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </a>
  </div>

  <div class="pt-32 pb-20 px-4">
    <article class="max-w-4xl mx-auto">
      <!-- Cabeçalho do artigo -->
      <header class="text-center mb-12">
        <div class="flex justify-center mb-6">
          <span
            class="px-4 py-1.5 rounded-full bg-orange-500/10 border border-orange-500/20 text-orange-400 text-xs font-bold uppercase tracking-wider"
          >
            {post.category}
          </span>
        </div>

        <h1 class="text-3xl md:text-5xl lg:text-6xl font-bold leading-tight mb-8 text-white">
          {post.title}
        </h1>

        <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-gray-400 border-b border-white/10 pb-8 mx-auto max-w-2xl">
          <div class="flex items-center gap-2">
            <!-- Calendar -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-orange-500">
              <path
                d="M8 2v3M16 2v3M3 9h18M5 5h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <span>{formattedDate}</span>
          </div>

          <div class="flex items-center gap-2">
            <!-- Clock -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-orange-500">
              <path
                d="M12 22a10 10 0 1010-10 10 10 0 00-10 10z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M12 6v6l4 2"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <span>{readMinutes} min de leitura</span>
          </div>

          <div class="flex items-center gap-2">
            <!-- User -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-orange-500">
              <path
                d="M20 21a8 8 0 10-16 0"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M12 13a4 4 0 100-8 4 4 0 000 8z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <span>IA Operators</span>
          </div>
        </div>
      </header>

      <!-- Imagem de capa -->
      {post.imageUrl && (
        <div class="mb-12 relative rounded-3xl overflow-hidden border border-white/10 shadow-2xl aspect-video">
          <img
            src={post.imageUrl}
            alt={post.title}
            loading="eager"
            fetchpriority="high"
            decoding="async"
            class="w-full h-full object-cover"
          />
          <div class="absolute inset-0 bg-linear-to-t from-[#050505] via-transparent to-transparent opacity-60" />
        </div>
      )}

      <!-- Conteúdo do artigo -->
      <div class="px-2 md:px-8">
        {post.content ? (
          <div
            class="
              prose prose-invert prose-lg max-w-none
              prose-headings:text-white prose-headings:font-bold prose-headings:leading-tight
              prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:border-l-4 prose-h2:border-orange-500 prose-h2:pl-4
              prose-h3:text-2xl prose-h3:text-orange-100/90 prose-h3:mt-8
              prose-p:text-gray-300 prose-p:leading-relaxed prose-p:mb-6
              prose-a:text-orange-500 prose-a:font-semibold prose-a:no-underline
              hover:prose-a:text-orange-400 hover:prose-a:underline transition-colors
              prose-ul:text-gray-300 prose-li:marker:text-orange-500
              prose-strong:text-white prose-strong:font-bold
              prose-blockquote:border-l-orange-500 prose-blockquote:bg-white/5 prose-blockquote:py-2 prose-blockquote:px-6
              prose-blockquote:rounded-r-lg prose-blockquote:text-gray-200 prose-blockquote:italic
              prose-img:rounded-2xl prose-img:shadow-xl prose-img:border prose-img:border-white/10
            "
            set:html={post.content}
          />
        ) : (
          <div
            class="
              prose prose-invert prose-lg max-w-none
              prose-p:text-gray-300 prose-p:leading-relaxed
            "
          >
            <p class="text-gray-400">Conteúdo em breve.</p>
          </div>
        )}
      </div>

      <!-- Rodapé / Share -->
      <div class="mt-16 pt-8 border-t border-white/10 flex flex-col md:flex-row items-center justify-between gap-6 px-8">
        <div class="text-gray-400 text-sm">Compartilhar</div>

        <div class="flex gap-4">
          <button
            type="button"
            class="p-3 rounded-full bg-[#151515] hover:bg-orange-500 hover:text-white transition-all text-gray-400"
            title="Copiar link"
            data-copy-link={canonicalUrl}
          >
            <!-- Share2 icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path
                d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M16 6l-4-4-4 4"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M12 2v14"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>

          <a
            href={shareLinkedIn}
            target="_blank"
            rel="noopener noreferrer"
            class="p-3 rounded-full bg-[#151515] hover:bg-[#0077b5] hover:text-white transition-all text-gray-400"
            title="Compartilhar no LinkedIn"
          >
            <!-- LinkedIn icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path
                d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4V9h4v2a4 4 0 014-3z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M2 9h4v12H2z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M4 4a2 2 0 110 4 2 2 0 010-4z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </a>

          <a
            href={shareX}
            target="_blank"
            rel="noopener noreferrer"
            class="p-3 rounded-full bg-[#151515] hover:bg-black hover:text-white transition-all text-gray-400 border border-transparent hover:border-white/20"
            title="Compartilhar no X"
          >
            <!-- Simple X icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path
                d="M4 4l16 16M20 4L4 20"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </a>
        </div>
      </div>
    </article>

    <!-- JS mínimo (client-side) para copiar link -->
    <script is:inline>
      (function () {
        const btn = document.querySelector('button[data-copy-link]');
        if (!btn) return;
        btn.addEventListener('click', async () => {
          const url = btn.getAttribute('data-copy-link') || window.location.href;
          try {
            await navigator.clipboard.writeText(url);
            btn.classList.add('text-white');
            setTimeout(() => btn.classList.remove('text-white'), 900);
          } catch (e) {
            // fallback antigo
            const input = document.createElement('input');
            input.value = url;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
          }
        });
      })();
    </script>
  </div>
</BaseLayout>
